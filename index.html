<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Trusterd - HTTP/2 Web Server scripting with mruby : " />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Trusterd - HTTP/2 Web Server scripting with mruby</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/matsumoto-r/trusterd">View on GitHub</a>

          <h1 id="project_title">Trusterd - HTTP/2 Web Server scripting with mruby</h1>
          <h2 id="project_tagline"></h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/matsumoto-r/trusterd/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/matsumoto-r/trusterd/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="trusterd-http2-web-server" class="anchor" href="#trusterd-http2-web-server"><span class="octicon octicon-link"></span></a>Trusterd HTTP/2 Web Server</h1>

<p>Trusterd is a high performance HTTP/2 Web Server scripting with <a href="https://github.com/mruby/mruby">mruby</a> using <a href="https://github.com/tatsuhiro-t/nghttp2">nghttp2</a> and <a href="https://github.com/matsumoto-r/mruby-http2">mruby-http2</a>. You can get HTTP/2 Web Server quickly which is high permance and customizable with mruby.</p>

<h2>
<a name="benchmark" class="anchor" href="#benchmark"><span class="octicon octicon-link"></span></a>Benchmark</h2>

<p>Please see <a href="https://gist.github.com/matsumoto-r/9702123">benchmark link</a>.</p>

<h2>
<a name="todo" class="anchor" href="#todo"><span class="octicon octicon-link"></span></a>TODO</h2>

<p>This is a very early version, please test and report errors. Wellcome pull-request.</p>

<ul>
<li>more customizable Web server configration</li>
</ul><h2>
<a name="quick-install" class="anchor" href="#quick-install"><span class="octicon octicon-link"></span></a>Quick install</h2>

<h4>
<a name="download-trusterd" class="anchor" href="#download-trusterd"><span class="octicon octicon-link"></span></a>Download trusterd</h4>

<pre><code>git clone https://github.com/matsumoto-r/trusterd.git
</code></pre>

<h4>
<a name="build-trusterd" class="anchor" href="#build-trusterd"><span class="octicon octicon-link"></span></a>Build trusterd</h4>

<div class="highlight highlight-bash"><pre><span class="nb">cd </span>trusterd
sh build.sh
</pre></div>

<p>then, output <code>bin/trusterd</code></p>

<h4>
<a name="write-config-conftrusterdconfrb" class="anchor" href="#write-config-conftrusterdconfrb"><span class="octicon octicon-link"></span></a>Write config <code>conf/trusterd.conf.rb</code>
</h4>

<div class="highlight highlight-ruby"><pre><span class="no">SERVER_NAME</span> <span class="o">=</span> <span class="s2">"Trusterd"</span>
<span class="no">SERVER_VERSION</span> <span class="o">=</span> <span class="s2">"0.0.1"</span>
<span class="no">SERVER_DESCRIPTION</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="no">SERVER_NAME</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="no">SERVER_VERSION</span><span class="si">}</span><span class="s2">"</span>

<span class="n">root_dir</span> <span class="o">=</span> <span class="s2">"/usr/local/trusterd"</span>

<span class="n">s</span> <span class="o">=</span> <span class="no">HTTP2</span><span class="o">::</span><span class="no">Server</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>

  <span class="c1">#</span>
  <span class="c1"># required config</span>
  <span class="c1">#</span>

  <span class="ss">:port</span>           <span class="o">=&gt;</span> <span class="mi">8080</span><span class="p">,</span>
  <span class="ss">:document_root</span>  <span class="o">=&gt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/htdocs"</span><span class="p">,</span>
  <span class="ss">:server_name</span>    <span class="o">=&gt;</span> <span class="no">SERVER_DESCRIPTION</span><span class="p">,</span>

  <span class="c1"># required when tls option is true.</span>
  <span class="c1"># tls option is true by default.</span>
  <span class="c1">#:key            =&gt; "#{root_dir}/ssl/server.key",</span>
  <span class="c1">#:crt            =&gt; "#{root_dir}/ssl/server.crt",</span>

  <span class="c1"># listen ip address</span>
  <span class="c1"># default value is 0.0.0.0</span>
  <span class="c1"># :server_host  =&gt; "127.0.0.1",</span>

  <span class="c1">#</span>
  <span class="c1"># optional config</span>
  <span class="c1">#</span>

  <span class="c1"># debug default: false</span>
  <span class="c1"># :debug  =&gt;  true,</span>

  <span class="c1"># tls default: true</span>
  <span class="ss">:tls</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>

  <span class="c1"># damone default: false</span>
  <span class="c1"># :daemon =&gt; true,</span>

  <span class="c1"># callback default: false</span>
  <span class="c1"># :callback =&gt; true,</span>

  <span class="c1"># connection_record defualt: true</span>
  <span class="c1"># :connection_record =&gt; false,</span>

<span class="p">})</span>

<span class="c1">#</span>
<span class="c1"># when :callback option is true,</span>
<span class="c1">#</span>
<span class="c1"># s.set_map_to_strage_cb {</span>
<span class="c1">#</span>
<span class="c1">#   p "callback bloack at set_map_to_strage_cb"</span>
<span class="c1">#   p s.request.uri</span>
<span class="c1">#   p s.request.filename</span>
<span class="c1">#</span>
<span class="c1">#   # location setting</span>
<span class="c1">#   if s.request.uri == "/index.html"</span>
<span class="c1">#     s.request.filename = "#{root_dir}/htdocs/hoge"</span>
<span class="c1">#   end</span>
<span class="c1">#   p s.request.filename</span>
<span class="c1">#</span>
<span class="c1">#   # you can use regexp if you link regexp mrbgem.</span>
<span class="c1">#   # Or, you can use KVS like mruby-redis or mruby-</span>
<span class="c1">#   # vedis and so on. </span>
<span class="c1">#</span>
<span class="c1"># }</span>

<span class="c1">#</span>
<span class="c1"># f = File.open "#{root_dir}/logs/access.log", "a"</span>
<span class="c1">#</span>
<span class="c1"># s.set_logging_cb {</span>
<span class="c1"># </span>
<span class="c1">#   p "callback block after send response"</span>
<span class="c1">#   f.write "#{s.conn.client_ip} #{Time.now} - #{s.r.uri} - #{s.r.filename}\n"</span>
<span class="c1">#</span>
<span class="c1"># }</span>

<span class="n">s</span><span class="o">.</span><span class="n">run</span>
</pre></div>

<h4>
<a name="create-directory-and-files" class="anchor" href="#create-directory-and-files"><span class="octicon octicon-link"></span></a>Create directory and files</h4>

<div class="highlight highlight-bash"><pre>mkdir -p /usr/local/trusterd/<span class="o">{</span>bin,htdocs,ssl,conf<span class="o">}</span>
cp bin/trusterd /usr/local/trusterd/bin/.
cp conf/trusterd.conf.rb /usr/local/trusterd/conf/.
<span class="nb">echo </span>hello trusterd world. &gt; /usr/local/trusterd/htdocs/index.html
</pre></div>

<h4>
<a name="run-trusterd" class="anchor" href="#run-trusterd"><span class="octicon octicon-link"></span></a>Run trusterd</h4>

<div class="highlight highlight-bash"><pre>/usr/local/trusterd/bin/trusterd /usr/local/trusterd/conf/trusterd.conf.rb
</pre></div>

<h4>
<a name="check-by-nghttp" class="anchor" href="#check-by-nghttp"><span class="octicon octicon-link"></span></a>Check by nghttp</h4>

<p><a href="https://github.com/tatsuhiro-t/nghttp2#nghttp---client">nghttp</a> is a client tool for HTTP/2.</p>

<pre><code>$ nghttp http://127.0.0.1:8080/index.html
hello trusterd world.
</code></pre>

<h2>
<a name="peformance" class="anchor" href="#peformance"><span class="octicon octicon-link"></span></a>Peformance</h2>

<p>Current mruby-http2 commit: 49d213b0aeb82e6bc72169a0a43bafbaf909ee2a</p>

<pre><code>$ h2load -w30 -W30 -n5000000 -c100 -m 100 http://127.0.0.1:8080/index.html
starting benchmark...
spawning thread #0: 100 concurrent clients, 5000000 total requests
progress: 10% done
progress: 20% done
progress: 30% done
progress: 40% done
progress: 50% done
progress: 60% done
progress: 70% done
progress: 80% done
progress: 90% done
progress: 100% done

finished in 21 sec, 840 millisec and 430 microsec, 228933 req/s, 5815 kbytes/s
requests: 5000000 total, 5000000 started, 5000000 done, 5000000 succeeded, 0 failed, 0 errored
status codes: 5000000 2xx, 0 3xx, 0 4xx, 0 5xx
traffic: 250069900 bytes total, 20067800 bytes headers, 110000000 bytes data
</code></pre>

<p>Please see <a href="https://gist.github.com/matsumoto-r/9702123">details</a>.</p>

<h2>
<a name="memory" class="anchor" href="#memory"><span class="octicon octicon-link"></span></a>Memory</h2>

<h4>
<a name="startup" class="anchor" href="#startup"><span class="octicon octicon-link"></span></a>Startup</h4>

<pre><code>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root     62085  0.0  0.0  46668  2288 pts/4    S+   16:41   0:00  |   \_ /usr/local/trusterd/bin/trusterd /usr/local/trusterd/conf/trusterd.conf.rb
</code></pre>

<h4>
<a name="after-processing-ten-million-request" class="anchor" href="#after-processing-ten-million-request"><span class="octicon octicon-link"></span></a>After processing ten million request</h4>

<pre><code>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root     62085 63.3  0.0  49200  5144 pts/4    S+   16:41   0:47  |   \_ /usr/local/trusterd/bin/trusterd /usr/local/trusterd/conf/trusterd.conf.rb
</code></pre>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>under the MIT License:</p>

<ul>
<li><a href="http://www.opensource.org/licenses/mit-license.php">http://www.opensource.org/licenses/mit-license.php</a></li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Trusterd - HTTP/2 Web Server scripting with mruby maintained by <a href="https://github.com/matsumoto-r">matsumoto-r</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
